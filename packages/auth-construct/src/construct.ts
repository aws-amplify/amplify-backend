import { Construct } from 'constructs';
import { aws_cognito as cognito, Stack } from 'aws-cdk-lib';
import {
  AuthResourceProvider,
  BackendOutputStorageStrategy,
  BackendOutputWriter,
} from '@aws-amplify/plugin-types';
import {
  UserPool,
  UserPoolClient,
  UserPoolProps,
} from 'aws-cdk-lib/aws-cognito';
import { FederatedPrincipal, Role } from 'aws-cdk-lib/aws-iam';
import { AuthOutput } from '@aws-amplify/backend-output-schemas/auth';
import { authOutputKey } from '@aws-amplify/backend-output-schemas';
import { AmplifyAuthProps } from './types.js';
import { DEFAULTS } from './defaults.js';
import { CUSTOM_ATTRIBUTE } from './utilities.js';

type DefaultRoles = { auth: Role; unAuth: Role };

/**
 * Amplify Auth CDK Construct
 */
export class AmplifyAuth
  extends Construct
  implements BackendOutputWriter, AuthResourceProvider
{
  /**
   * The resources generated by the construct.
   */
  public readonly resources;
  /**
   * Create a new Auth construct with AuthProps.
   * If no props are provided, email login and defaults will be used.
   */
  constructor(scope: Construct, id: string, optionalProps?: AmplifyAuthProps) {
    super(scope, id);
    // use provided props or use defaults
    const props = optionalProps ?? DEFAULTS.IF_NO_PROPS_PROVIDED;

    // UserPool
    const userPoolProps: UserPoolProps = this.getUserPoolProps(props);
    const userPool = new cognito.UserPool(this, 'UserPool', userPoolProps);

    // UserPool Client
    const userPoolClientWeb = new cognito.UserPoolClient(
      this,
      'UserPoolWebClient',
      {
        userPool: userPool,
        authFlows: DEFAULTS.AUTH_FLOWS,
      }
    );

    // Auth / UnAuth Roles
    const { auth, unAuth } = this.setupAuthAndUnAuthRoles();

    // Identity Pool
    const { identityPool, identityPoolRoleAttachment } = this.setupIdentityPool(
      { auth, unAuth },
      userPool,
      userPoolClientWeb
    );

    // expose resources
    this.resources = {
      userPool,
      userPoolClientWeb,
      authenticatedUserIamRole: auth,
      unauthenticatedUserIamRole: unAuth,
      cfnResources: {
        identityPool,
        identityPoolRoleAttachment,
      },
    };
  }

  /**
   * Create Auth/UnAuth Roles
   * @returns DefaultRoles
   */
  private setupAuthAndUnAuthRoles(): DefaultRoles {
    const result: DefaultRoles = {
      auth: new Role(this, 'authenticatedUserRole', {
        assumedBy: new FederatedPrincipal('cognito-identity.amazonaws.com'),
      }),
      unAuth: new Role(this, 'unauthenticatedUserRole', {
        assumedBy: new FederatedPrincipal('cognito-identity.amazonaws.com'),
      }),
    };
    return result;
  }

  /**
   * Setup Identity Pool with default roles/role mappings, and register providers
   * @param roles - DefaultRoles
   * @param userPool - UserPool
   * @param userPoolClient - UserPoolClient
   */
  private setupIdentityPool(
    roles: DefaultRoles,
    userPool: UserPool,
    userPoolClient: UserPoolClient
  ) {
    // setup identity pool
    const region = Stack.of(this).region;
    const identityPool = new cognito.CfnIdentityPool(this, 'IdentityPool', {
      allowUnauthenticatedIdentities: DEFAULTS.ALLOW_UNAUTHENTICATED_IDENTITIES,
    });
    const identityPoolRoleAttachment =
      new cognito.CfnIdentityPoolRoleAttachment(
        this,
        'IdentityPoolRoleAttachment',
        {
          identityPoolId: identityPool.logicalId,
          roles: {
            unauthenticated: roles.unAuth.roleArn,
            authenticated: roles.auth.roleArn,
          },
          roleMappings: {
            UserPoolWebClientRoleMapping: {
              type: 'Token',
              ambiguousRoleResolution: 'AuthenticatedRole',
              identityProvider: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}:${userPoolClient.userPoolClientId}`,
            },
          },
        }
      );
    identityPoolRoleAttachment.addDependency(identityPool);
    identityPoolRoleAttachment.node.addDependency(userPoolClient);
    // add cognito provider
    identityPool.cognitoIdentityProviders = [
      {
        clientId: userPoolClient.userPoolClientId,
        providerName: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolProviderName}`,
      },
    ];
    return {
      identityPool,
      identityPoolRoleAttachment,
    };
  }

  /**
   * Process props into UserPoolProps (set defaults if needed)
   * @param props - AmplifyAuthProps
   * @returns UserPoolProps
   */
  private getUserPoolProps(props: AmplifyAuthProps): UserPoolProps {
    const emailEnabled = props.email ? true : false;
    const phoneEnabled = props.phoneNumber ? true : false;
    // check for customizations
    let userVerificationSettings: cognito.UserVerificationConfig = {};
    if (emailEnabled) {
      if (typeof props.email === 'object') {
        userVerificationSettings = {
          emailBody: props.email.emailBody,
          emailStyle: props.email.emailStyle,
          emailSubject: props.email.emailSubject,
        };
      }
    }
    if (phoneEnabled) {
      if (typeof props.phoneNumber === 'object') {
        userVerificationSettings = {
          ...userVerificationSettings,
          smsMessage: props.phoneNumber.verificationMessage,
        };
      }
    }
    // if custom attributes were provided, convert them to valid input
    let customAttributes: {
      [key: string]: cognito.ICustomAttribute;
    } = {};
    if (props.settings?.customAttributes) {
      for (const customAttribute of props.settings.customAttributes) {
        customAttributes = {
          ...customAttribute,
        };
      }
    }
    const userPoolProps: UserPoolProps = {
      signInCaseSensitive: DEFAULTS.SIGN_IN_CASE_SENSITIVE,
      signInAliases: {
        phone: phoneEnabled,
        email: emailEnabled,
      },
      keepOriginal: {
        email: emailEnabled,
        phone: phoneEnabled,
      },
      userVerification: userVerificationSettings,
      passwordPolicy: DEFAULTS.PASSWORD_POLICY,
      standardAttributes: {
        email: DEFAULTS.IS_REQUIRED_ATTRIBUTE.email(emailEnabled),
        phoneNumber: DEFAULTS.IS_REQUIRED_ATTRIBUTE.phoneNumber(phoneEnabled),
        ...(props.settings?.standardAttributes ?? {}),
      },
      customAttributes: {
        ...customAttributes,
      },
    };
    return userPoolProps;
  }

  /**
   * Stores auth output using the provided strategy
   */
  storeOutput(
    outputStorageStrategy: BackendOutputStorageStrategy<AuthOutput>
  ): void {
    outputStorageStrategy.addBackendOutputEntry(authOutputKey, {
      version: '1',
      payload: {
        userPoolId: this.resources.userPool.userPoolId,
        webClientId: this.resources.userPoolClientWeb.userPoolClientId,
        authRegion: Stack.of(this).region,
      },
    });
  }

  /**
   * Utility for adding custom attributes.
   *
   * Example:
   * customAttributes: [
   *  AmplifyAuth.customAttribute.string('eyeColor', { 'maxLength': 12 })
   * ]
   */
  public static customAttribute = CUSTOM_ATTRIBUTE;
}
